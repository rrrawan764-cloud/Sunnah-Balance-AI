// ===== Justice Platform Application =====
class JusticePlatform {
    constructor() {
        this.currentMode = 'citizen';
        this.isDarkMode = true;
        this.isAuthenticated = false;
        this.user = null;
        this.isOnline = true;
        this.voiceSupported = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
        this.init();
    }

    async init() {
        // Show splash screen
        await this.showSplashScreen();
        
        // Initialize modules
        this.initBackground();
        this.initEventListeners();
        this.initServices();
        this.loadPreferences();
        this.checkNetworkStatus();
        
        // Initialize UI
        this.updateUserInterface();
        
        // Show welcome notification
        setTimeout(() => {
            this.showNotification('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø±ÙˆØ§Ù‚ Ø§Ù„Ø¹Ø¯Ù„', 'Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø°ÙƒÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù‚Ø¶Ø§Ø¦ÙŠØ©', 'info');
            this.showTourGuide();
        }, 1500);
    }

    // ===== Splash Screen =====
    async showSplashScreen() {
        const splash = document.getElementById('splashScreen');
        const progress = document.getElementById('loadingProgress');
        
        // Simulate loading
        let progressValue = 0;
        const interval = setInterval(() => {
            progressValue += Math.random() * 10;
            progress.style.width = `${Math.min(progressValue, 100)}%`;
            
            if (progressValue >= 100) {
                clearInterval(interval);
                setTimeout(() => {
                    splash.style.opacity = '0';
                    setTimeout(() => {
                        splash.style.display = 'none';
                    }, 500);
                }, 500);
            }
        }, 100);
    }

    // ===== Event Listeners =====
    initEventListeners() {
        // Mode switching
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const mode = e.currentTarget.dataset.mode;
                this.switchMode(mode, e.currentTarget);
            });
        });

        // Theme toggle
        document.getElementById('themeToggle').addEventListener('click', () => {
            this.toggleDarkMode();
        });

        // User menu
        document.getElementById('userMenuBtn').addEventListener('click', (e) => {
            this.toggleUserMenu(e);
        });

        // Close user menu when clicking outside
        document.addEventListener('click', (e) => {
            const userMenu = document.getElementById('userMenu');
            const userMenuBtn = document.getElementById('userMenuBtn');
            
            if (userMenu.classList.contains('show') && 
                !userMenu.contains(e.target) && 
                !userMenuBtn.contains(e.target)) {
                userMenu.classList.remove('show');
            }
        });

        // Login/Register
        document.getElementById('loginBtn')?.addEventListener('click', (e) => {
            e.preventDefault();
            this.showLoginModal();
        });

        document.getElementById('registerBtn')?.addEventListener('click', (e) => {
            e.preventDefault();
            this.showRegisterModal();
        });

        // AI Assistant
        document.getElementById('assistantToggle').addEventListener('click', () => {
            this.toggleAssistant();
        });

        // Chat messages
        document.getElementById('sendMessage')?.addEventListener('click', () => {
            this.sendChatMessage();
        });

        document.getElementById('chatInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.sendChatMessage();
            }
        });

        // Close buttons
        document.querySelectorAll('.modal-close, .chat-close').forEach(btn => {
            btn.addEventListener('click', () => {
                this.closeModals();
            });
        });

        // Close modals on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    this.closeModals();
                }
            });
        });

        // Form submissions
        document.getElementById('loginForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleLogin();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            this.handleKeyboardShortcuts(e);
        });

        // Network status
        window.addEventListener('online', () => this.handleNetworkChange(true));
        window.addEventListener('offline', () => this.handleNetworkChange(false));
    }

    // ===== Mode Management =====
    switchMode(mode, button) {
        this.currentMode = mode;
        
        // Update buttons
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        button.classList.add('active');
        
        // Update view
        this.loadModeContent(mode);
        
        // Save preference
        this.savePreferences();
        
        // Show notification
        this.showModeNotification(mode);
    }

    async loadModeContent(mode) {
        try {
            // In production, this would load content from server
            // For now, we'll use embedded content
            const mainContainer = document.querySelector('.main-container');
            
            // Show loading
            mainContainer.innerHTML = this.createLoaderHTML('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...');
            
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // Load mode content
            const content = this.getModeContent(mode);
            mainContainer.innerHTML = content;
            
            // Initialize mode-specific event listeners
            this.initModeListeners(mode);
            
        } catch (error) {
            console.error('Error loading mode content:', error);
            this.showNotification('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰', 'error');
        }
    }

    getModeContent(mode) {
        const templates = {
            citizen: this.getCitizenContent(),
            judge: this.getJudgeContent(),
            lawyer: this.getLawyerContent(),
            blind: this.getBlindContent()
        };
        
        return templates[mode] || this.getCitizenContent();
    }

    getCitizenContent() {
        return `
            <div class="welcome-banner">
                <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ù†ØµØ© Ø±ÙˆØ§Ù‚ Ø§Ù„Ø¹Ø¯Ù„ Ø§Ù„Ø°ÙƒÙŠØ©</h2>
                <p>Ù…Ù†ØµØ© Ø´Ø§Ù…Ù„Ø© ØªÙ‚Ø¯Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù‚Ø¶Ø§Ø¦ÙŠØ© Ø¨Ø°ÙƒØ§Ø¡ ÙˆØ³Ù‡ÙˆÙ„Ø© ÙˆØ£Ù…Ø§Ù†ØŒ Ù…ØµÙ…Ù…Ø© Ø®ØµÙŠØµØ§Ù‹ Ù„ØªÙ„Ø¨ÙŠØ© Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙƒ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø¨ÙƒÙ„ ÙŠØ³Ø±</p>
            </div>

            <div class="citizen-grid">
                <!-- Citizen services grid would be here -->
                <div class="service-card" data-service="new-case">
                    <div class="service-icon">
                        <i class="fas fa-file-contract"></i>
                    </div>
                    <h3>Ø±ÙØ¹ Ø¯Ø¹ÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø©</h3>
                    <p>Ø§Ø¨Ø¯Ø£ Ø¯Ø¹ÙˆÙ‰ Ù‚Ø¶Ø§Ø¦ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
                    <span class="service-badge">Ø®Ø¯Ù…Ø© Ø°ÙƒÙŠØ©</span>
                </div>
                <!-- Add more service cards -->
            </div>

            <div class="input-group">
                <h3><i class="fas fa-robot"></i> Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ø§Ù„Ø°ÙƒÙŠ</h3>
                <p>Ø§Ø·Ø±Ø­ Ø³Ø¤Ø§Ù„Ùƒ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ</p>
                <div class="input-with-icon">
                    <i class="input-icon fas fa-question-circle"></i>
                    <textarea id="citizenQuestion" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..."></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="platform.runAI('citizen')">
                        <i class="fas fa-brain"></i> ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ
                    </button>
                    <button class="btn btn-secondary" onclick="platform.voiceInput('citizenQuestion')">
                        <i class="fas fa-microphone"></i> Ø¥Ø¯Ø®Ø§Ù„ ØµÙˆØªÙŠ
                    </button>
                </div>
                <div id="citizenAiResult" class="result-area"></div>
            </div>
        `;
    }

    getJudgeContent() {
        // Similar structure for judge content
        return `<div>Judge Interface Content</div>`;
    }

    getLawyerContent() {
        // Similar structure for lawyer content
        return `<div>Lawyer Interface Content</div>`;
    }

    getBlindContent() {
        // Similar structure for blind content
        return `<div>Blind Interface Content</div>`;
    }

    // ===== Authentication =====
    showLoginModal() {
        this.closeUserMenu();
        document.getElementById('loginModal').classList.add('show');
    }

    showRegisterModal() {
        this.closeUserMenu();
        // Implementation for register modal
        this.showNotification('Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'info');
    }

    async handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        try {
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // For demo purposes
            this.isAuthenticated = true;
            this.user = {
                name: 'Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯',
                email: email,
                role: 'user'
            };
            
            this.updateUserInterface();
            this.closeModals();
            this.showNotification('ØªÙ… Ø¨Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            
        } catch (error) {
            this.showNotification('Ø®Ø·Ø£', 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
        }
    }

    handleLogout() {
        this.isAuthenticated = false;
        this.user = null;
        this.updateUserInterface();
        this.showNotification('ØªÙ…', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'info');
    }

    // ===== AI Assistant =====
    toggleAssistant() {
        const chat = document.getElementById('assistantChat');
        chat.classList.toggle('show');
    }

    async sendChatMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        // Add user message
        this.addChatMessage(message, 'user');
        input.value = '';
        
        // Show typing indicator
        this.showTypingIndicator();
        
        // Get AI response
        setTimeout(() => {
            this.hideTypingIndicator();
            const response = this.generateAIResponse(message);
            this.addChatMessage(response, 'assistant');
        }, 1500);
    }

    addChatMessage(text, sender) {
        const messages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        messageDiv.textContent = text;
        messages.appendChild(messageDiv);
        messages.scrollTop = messages.scrollHeight;
    }

    showTypingIndicator() {
        const messages = document.getElementById('chatMessages');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message assistant typing';
        typingDiv.innerHTML = '<div class="typing-dots"><span>.</span><span>.</span><span>.</span></div>';
        typingDiv.id = 'typingIndicator';
        messages.appendChild(typingDiv);
        messages.scrollTop = messages.scrollHeight;
    }

    hideTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) indicator.remove();
    }

    generateAIResponse(message) {
        const responses = [
            "Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ ÙÙŠ Ø±ÙˆØ§Ù‚ Ø§Ù„Ø¹Ø¯Ù„. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ",
            "ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù‚Ø¶Ø§Ø¦ÙŠØ© ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ø³ØªÙØ³Ø§Ø±Ø§ØªÙƒ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©.",
            "Ù„Ø±ÙØ¹ Ø¯Ø¹ÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø© 'Ø±ÙØ¹ Ø¯Ø¹ÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø©' ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ§Ø·Ù†.",
            "Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ù‚Ø¶ÙŠØ©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø© 'Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¯Ø¹Ø§ÙˆÙ‰'.",
            "Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³ØªØ´Ø§Ø±Ø© Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ù…ØªØ®ØµØµØ©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø© 'Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©'."
        ];
        
        // Simple keyword matching for demo
        if (message.includes('Ø¯Ø¹ÙˆÙ‰') || message.includes('Ù‚Ø¶ÙŠØ©')) {
            return "ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø±ÙØ¹ Ø¯Ø¹ÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ù…ØªØ§Ø¨Ø¹Ø© Ù‚Ø¶ÙŠØ© Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„ØŸ";
        } else if (message.includes('Ø§Ø³ØªØ´Ø§Ø±Ø©') || message.includes('Ù†ØµÙŠØ­Ø©')) {
            return "Ø£Ù‚ØªØ±Ø­ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø© 'Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©' Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ Ù…ÙØµÙ„ Ù„Ø­Ø§Ù„ØªÙƒ.";
        } else if (message.includes('Ù…ÙˆØ¹Ø¯') || message.includes('Ø¬Ù„Ø³Ø©')) {
            return "ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ ÙÙŠ Ø§Ù„Ù…Ø­ÙƒÙ…Ø© Ù…Ù† Ø®Ù„Ø§Ù„ Ø®Ø¯Ù…Ø© 'Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯'.";
        }
        
        return responses[Math.floor(Math.random() * responses.length)];
    }

    // ===== Network Management =====
    checkNetworkStatus() {
        this.isOnline = navigator.onLine;
        this.updateNetworkIndicator();
    }

    handleNetworkChange(online) {
        this.isOnline = online;
        this.updateNetworkIndicator();
        
        if (!online) {
            this.showNotification('ØªØ­Ø°ÙŠØ±', 'ØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'warning');
        } else {
            this.showNotification('ØªÙ…', 'ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'success');
        }
    }

    updateNetworkIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'offline-indicator';
        indicator.id = 'networkIndicator';
        
        if (!this.isOnline) {
            indicator.innerHTML = '<i class="fas fa-wifi-slash"></i> Ø£Ù†Øª ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
            indicator.style.display = 'block';
            
            if (!document.getElementById('networkIndicator')) {
                document.body.appendChild(indicator);
            }
        } else {
            const existing = document.getElementById('networkIndicator');
            if (existing) {
                existing.remove();
            }
        }
    }

    // ===== User Interface Updates =====
    updateUserInterface() {
        // Update user info
        const userAvatar = document.querySelector('.user-avatar');
        const userName = document.querySelector('.user-details h4');
        const userEmail = document.querySelector('.user-details p');
        
        if (this.isAuthenticated && this.user) {
            userAvatar.innerHTML = `<i class="fas fa-user-check"></i>`;
            userName.textContent = this.user.name;
            userEmail.textContent = this.user.email;
        } else {
            userAvatar.innerHTML = `<i class="fas fa-user"></i>`;
            userName.textContent = 'Ø²Ø§Ø¦Ø±';
            userEmail.textContent = 'Ù„Ù… ØªÙ‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        }
        
        // Update menu items
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.querySelector('.menu-item:last-child');
        
        if (this.isAuthenticated) {
            loginBtn.style.display = 'none';
            logoutBtn.style.display = 'flex';
        } else {
            loginBtn.style.display = 'flex';
            logoutBtn.style.display = 'none';
        }
    }

    toggleUserMenu(e) {
        e.stopPropagation();
        const menu = document.getElementById('userMenu');
        menu.classList.toggle('show');
    }

    closeUserMenu() {
        document.getElementById('userMenu').classList.remove('show');
    }

    closeModals() {
        document.querySelectorAll('.modal').forEach(modal => {
            modal.classList.remove('show');
        });
        document.getElementById('assistantChat').classList.remove('show');
    }

    // ===== Tour Guide =====
    showTourGuide() {
        if (localStorage.getItem('tourCompleted')) return;
        
        const tour = document.createElement('div');
        tour.className = 'tour-guide';
        tour.innerHTML = `
            <h4>ğŸš€ Ø¬ÙˆÙ„Ø© Ø³Ø±ÙŠØ¹Ø©</h4>
            <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ø¥Ù„ÙŠÙƒ ÙƒÙŠÙÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù†ØµØ©:</p>
            <ol style="margin-right: 1rem; margin-top: 1rem;">
                <li>Ø§Ø®ØªØ± ÙˆØ§Ø¬Ù‡ØªÙƒ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰</li>
                <li>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</li>
                <li>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙŠØ²Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</li>
            </ol>
            <button class="btn btn-primary btn-block" style="margin-top: 1rem;" onclick="this.closest('.tour-guide').remove(); localStorage.setItem('tourCompleted', 'true');">
                ÙÙ‡Ù…ØªØŒ Ø´ÙƒØ±Ø§Ù‹!
            </button>
        `;
        
        document.body.appendChild(tour);
        
        // Auto remove after 30 seconds
        setTimeout(() => {
            if (tour.parentNode) {
                tour.remove();
            }
        }, 30000);
    }

    // ===== Helper Methods =====
    createLoaderHTML(message) {
        return `
            <div class="loading">
                <div class="spinner"></div>
                <p>${message}</p>
            </div>
        `;
    }

    showNotification(title, message, type = 'info') {
        // Implementation from previous code
    }

    toggleDarkMode() {
        this.isDarkMode = !this.isDarkMode;
        document.body.classList.toggle('light-mode', !this.isDarkMode);
        
        // Update icon
        const icon = document.querySelector('#themeToggle i');
        icon.className = this.isDarkMode ? 'fas fa-moon' : 'fas fa-sun';
        
        this.showNotification('ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶', 
            this.isDarkMode ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†' : 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­', 
            'info');
        
        this.savePreferences();
    }

    showModeNotification(mode) {
        const messages = {
            citizen: { title: 'ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ§Ø·Ù†', message: 'Ø®Ø¯Ù…Ø§Øª Ù‚Ø¶Ø§Ø¦ÙŠØ© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ†' },
            judge: { title: 'ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‚Ø§Ø¶ÙŠ', message: 'Ø£Ø¯ÙˆØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ù„Ù‚Ø¶Ø§Ø© ÙˆØ§Ù„Ù…Ø¹Ø§ÙˆÙ†ÙŠÙ†' },
            lawyer: { title: 'ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ø§Ù…ÙŠ', message: 'Ù…Ù†ØµØ© Ù…ØªÙƒØ§Ù…Ù„Ø© Ù„Ù„Ù…Ø­Ø§Ù…ÙŠÙ† ÙˆØ§Ù„Ù…Ø³ØªØ´Ø§Ø±ÙŠÙ†' },
            blind: { title: 'ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙƒÙÙˆÙÙŠÙ†', message: 'Ù…Ù†ØµØ© ØµÙˆØªÙŠØ© Ù…ØªÙƒØ§Ù…Ù„Ø© Ù„Ù„Ù…ÙƒÙÙˆÙÙŠÙ†' }
        };
        
        if (messages[mode]) {
            this.showNotification(messages[mode].title, messages[mode].message, 'info');
        }
    }

    handleKeyboardShortcuts(e) {
        // Ctrl + / for help
        if (e.ctrlKey && e.key === '/') {
            e.preventDefault();
            this.showHelp();
        }
        
        // Ctrl + N for notifications
        if (e.ctrlKey && e.key === 'n') {
            e.preventDefault();
            this.showNotifications();
        }
        
        // Ctrl + D for dark mode
        if (e.ctrlKey && e.key === 'd') {
            e.preventDefault();
            this.toggleDarkMode();
        }
        
        // Escape to close
        if (e.key === 'Escape') {
            this.closeModals();
            this.closeUserMenu();
        }
    }

    // ===== Services Initialization =====
    initServices() {
        // Initialize background service workers
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(console.error);
        }
        
        // Initialize voice recognition
        if (this.voiceSupported) {
            console.log('Voice recognition is supported');
        }
        
        // Initialize offline capabilities
        this.setupOfflineCache();
    }

    setupOfflineCache() {
        // Implementation for offline caching
        if ('caches' in window) {
            caches.open('justice-platform-v1').then(cache => {
                // Cache critical resources
                cache.addAll([
                    '/',
                    '/index.html',
                    '/css/styles.min.css',
                    '/js/app.min.js'
                ]).catch(console.error);
            });
        }
    }

    // ===== Preferences Management =====
    savePreferences() {
        const preferences = {
            mode: this.currentMode,
            darkMode: this.isDarkMode,
            authenticated: this.isAuthenticated
        };
        
        try {
            localStorage.setItem('justicePlatformPrefs', JSON.stringify(preferences));
        } catch (e) {
            console.error('Error saving preferences:', e);
        }
    }

    loadPreferences() {
        try {
            const saved = localStorage.getItem('justicePlatformPrefs');
            if (saved) {
                const prefs = JSON.parse(saved);
                
                this.currentMode = prefs.mode || 'citizen';
                this.isDarkMode = prefs.darkMode !== undefined ? prefs.darkMode : true;
                
                // Apply preferences
                document.body.classList.toggle('light-mode', !this.isDarkMode);
                
                // Update theme icon
                const icon = document.querySelector('#themeToggle i');
                if (icon) {
                    icon.className = this.isDarkMode ? 'fas fa-moon' : 'fas fa-sun';
                }
                
                // Switch to saved mode
                const modeBtn = document.querySelector(`.mode-btn.${this.currentMode}`);
                if (modeBtn) {
                    this.switchMode(this.currentMode, modeBtn);
                }
            }
        } catch (e) {
            console.error('Error loading preferences:', e);
        }
    }

    // ===== Background Engine (from previous code) =====
    initBackground() {
        // Implementation from previous code
    }
}

// ===== Initialize Application =====
let platform;

document.addEventListener('DOMContentLoaded', () => {
    platform = new JusticePlatform();
    
    // Make platform available globally
    window.platform = platform;
    
    // Handle service worker updates
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            window.location.reload();
        });
    }
});

// ===== PWA Installation =====
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
    // Prevent Chrome 67 and earlier from automatically showing the prompt
    e.preventDefault();
    // Stash the event so it can be triggered later
    deferredPrompt = e;
    
    // Show install button
    const installBtn = document.createElement('button');
    installBtn.className = 'install-btn';
    installBtn.innerHTML = '<i class="fas fa-download"></i> ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚';
    installBtn.addEventListener('click', () => {
        // Show the install prompt
        deferredPrompt.prompt();
        // Wait for the user to respond to the prompt
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
                console.log('User accepted the install prompt');
            }
            deferredPrompt = null;
        });
    });
    
    document.body.appendChild(installBtn);
});

// ===== Error Handling =====
window.addEventListener('error', (e) => {
    console.error('Application error:', e);
    platform?.showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
});

// ===== Performance Monitoring =====
if ('performance' in window) {
    window.addEventListener('load', () => {
        setTimeout(() => {
            const perfData = window.performance.timing;
            const loadTime = perfData.loadEventEnd - perfData.navigationStart;
            console.log(`Page loaded in ${loadTime}ms`);
        }, 0);
    });
}
